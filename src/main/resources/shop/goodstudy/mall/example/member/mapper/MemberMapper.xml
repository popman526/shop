<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="shop.goodstudy.mall.example.member.mapper.MemberMapper">

	<resultMap type="member" id="memberMap">
		<result property="id" column="ID" />
		<result property="memberId" column="MEMBER_ID" />
		<result property="password" column="PASSWORD" />
		<result property="name" column="NAME" />
		<collection property="roles" ofType="String">
			<result property="roleCode" column="ROLE_CODE" />
		</collection>
		<collection property="roleNames" ofType="String">
			<result property="roleName" column="ROLE_NAME" />
		</collection>
	</resultMap>
	

<!-- 	<select id="findAll" resultType="member"> -->
	<select id="findAll" resultMap="memberMap">
		SELECT
			A.*
			, B.ROLE_CODE AS ROLES
			, B.ROLE_NAME AS ROLE_NAMES
		FROM (
			SELECT 
				ID
				, MEMBER_ID
				, PASSWORD
				, NAME
			FROM MEMBER
			) A
		JOIN (
			SELECT 
				C.MEMBER_ID
				, C.ROLE_CODE
				, D.ROLE_NAME
			FROM MEMBER_ROLES C
			JOIN ROLES D
			ON C.ROLE_CODE = D.ROLE_CODE
		) B
		ON A.MEMBER_ID = B.MEMBER_ID
	</select>

	<select id="findById" resultType="member">
		SELECT 
			ID
			, MEMBER_ID
			, PASSWORD
			, NAME
		FROM MEMBER
		WHERE ID = #{id}
	</select>

<!-- 	<select id="findByMemberId" resultType="member"> -->
	<select id="findByMemberId" resultMap="memberMap">
		SELECT
			A.*
			, B.ROLE_CODE AS ROLES
			, B.ROLE_NAME AS ROLE_NAMES
		FROM (
			SELECT 
				ID
				, MEMBER_ID
				, PASSWORD
				, NAME
			FROM MEMBER
			WHERE MEMBER_ID = #{memberId}
			) A
		JOIN (
			SELECT 
				C.MEMBER_ID
				, C.ROLE_CODE
				, D.ROLE_NAME
			FROM MEMBER_ROLES C
			JOIN ROLES D
			ON C.ROLE_CODE = D.ROLE_CODE
			WHERE MEMBER_ID = #{memberId}
		) B
		ON A.MEMBER_ID = B.MEMBER_ID
	</select>
	
	<insert id="add" parameterType="member" >
		INSERT INTO MEMBER (
			MEMBER_ID
			, PASSWORD
			, NAME
		) VALUES (
			#{memberId}
			, #{password}
			, #{name}
		)
	</insert>
	
	<update id="modify" parameterType="member" >
		UPDATE MEMBER 
		SET
			MEMBER_ID = #{memberId}
			, PASSWORD = #{password}
			, NAME = #{name}
		WHERE ID = #{id}
	</update>
	
	<delete id="delete" parameterType="member" >
		DELETE MEMBER 
		WHERE ID = #{id}
	</delete>
</mapper>